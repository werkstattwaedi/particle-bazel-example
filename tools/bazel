#!/usr/bin/zsh
set -uo pipefail

OVERWRITE_THRESHOLD=$(date +%s)

$BAZEL_REAL "$@"
BAZEL_EXIT_CODE=$?

if [[ -n "${PW_IDE_VERBOSE-}" ]]; then
  QUIET_BUILD=
  VERBOSE_FLAG=--verbose
else
  QUIET_BUILD=--quiet
  VERBOSE_FLAG=
fi

if [[ $# -gt 0 && ( "$1" == "build" || "$1" == "run" || "$1" == "test" ) ]]; then
  if [ $BAZEL_EXIT_CODE -eq 0 ]; then
    echo "ðŸ”„ Refreshing compile commands..." >&2
    $BAZEL_REAL ${QUIET_BUILD} run --show_result=0 --experimental_convenience_symlinks=ignore @pigweed//pw_ide/bazel:update_compile_commands -- ${VERBOSE_FLAG} --overwrite-threshold=${OVERWRITE_THRESHOLD} -- "$@"
    if [ $? -eq 0 ]; then
      mkdir -p .compile_commands
      echo "$*" > .compile_commands/pwLastBazelCommand.txt
    else
      echo "âš ï¸ Compile commands generation failed (exit code $?)" >&2
    fi
  fi
fi

exit $BAZEL_EXIT_CODE

# Particle Device OS SDK for P2 (RTL8721DM / Cortex-M33)
# Sources from Device OS 6.3.3 submodule
# License: LGPL v3

package(default_visibility = ["//visibility:public"])

# =============================================================================
# Configuration
# =============================================================================

# Platform: P2 (tron)
PLATFORM_ID = 32
PLATFORM_NAME = "p2"
PLATFORM_GEN = 3
DEVICE_OS_VERSION = 6303  # 6.3.3

# Common defines for all Device OS modules
DEVICE_OS_DEFINES = [
    "PLATFORM_ID={}".format(PLATFORM_ID),
    "PLATFORM_NAME={}".format(PLATFORM_NAME),
    "PLATFORM_GEN={}".format(PLATFORM_GEN),
    "MCU_DEVICE",
    "rtl872x",
    "CONFIG_PLATFORM_8721D",
    "MODULAR_FIRMWARE=1",
    "MODULE_VERSION=6",
    "MODULE_FUNCTION=5",  # MOD_FUNC_USER_PART
    "MODULE_INDEX=1",
    "MODULE_DEPENDENCY=4,1,{}".format(DEVICE_OS_VERSION),
    "MODULE_DEPENDENCY2=0,0,0",
    "HAL_PLATFORM_RTL872X=1",
    "HAL_PLATFORM_MODULE_SUFFIX_EXTENSIONS=1",
    "HAL_PLATFORM_MODULE_DYNAMIC_LOCATION=1",
    "PARTICLE_USER_MODULE=1",
    "_GNU_SOURCE",
    "USE_STDPERIPH_DRIVER",
    "PLATFORM_THREADING=1",
    "RELEASE_BUILD",  # Suppress "Defaulting to Release Build" warning
    "__FPU_PRESENT=1",  # Cortex-M33 has FPU
    "ARM_CPU_CORTEX_M33",  # Select correct CMSIS header
]

# Common compiler flags for Device OS (LTO for compile)
DEVICE_OS_COPTS = [
    "-flto",
    "-ffat-lto-objects",
    # Relax warnings for vendored Device OS code
    "-Wno-redundant-decls",
    "-Wno-switch",
    "-Wno-unused-parameter",
    "-Wno-cast-qual",
    "-Wno-missing-field-initializers",
    "-Wno-shadow",
    "-Wno-undef",
]

# Additional C++ flags
DEVICE_OS_CXXOPTS = DEVICE_OS_COPTS + [
    "-fno-exceptions",
    "-fno-rtti",
    "-fcheck-new",
    "-fno-use-cxa-atexit",
]

# Include directories from Device OS
DEVICE_OS_INCLUDES = [
    "device-os/wiring/inc",
    "device-os/hal/inc",
    "device-os/hal/shared",
    "device-os/hal/src/tron",
    "device-os/hal/src/rtl872x",
    "device-os/hal/src/rtl872x/lwip",
    "device-os/hal/src/rtl872x/freertos",
    "device-os/hal/src/rtl872x/mbedtls",
    "device-os/hal/src/rtl872x/littlefs",
    "device-os/hal/src/rtl872x/posix",
    "device-os/hal/src/portable",
    "device-os/hal/src/portable/FreeRTOS",
    "device-os/hal/network",
    "device-os/hal/network/api",
    "device-os/hal/network/lwip",
    "device-os/hal/network/lwip/posix",
    "device-os/hal/network/lwip/wiznet",
    "device-os/hal/network/ncp",
    "device-os/hal/network/ncp/at_parser",
    "device-os/hal/network/ncp_client",
    "device-os/hal/network/util",
    "device-os/system/inc",
    "device-os/services/inc",
    "device-os/dynalib/inc",
    "device-os/platform/MCU/rtl872x/inc",
    "device-os/modules/shared/rtl872x/inc/user-part",
    "device-os/modules/shared/rtl872x/inc",
    "device-os/communication/inc",
    "device-os/rt-dynalib/inc",
    # Realtek SDK (ambd_sdk) includes
    "device-os/third_party/ambd_sdk",
    "device-os/third_party/ambd_sdk/ambd_sdk/component/soc/realtek/amebad",
    "device-os/third_party/ambd_sdk/ambd_sdk/component/soc/realtek/amebad/cmsis",
    "device-os/third_party/ambd_sdk/ambd_sdk/component/soc/realtek/amebad/fwlib/include",
    "device-os/third_party/ambd_sdk/ambd_sdk/component/soc/realtek/amebad/swlib/include",
    "device-os/third_party/ambd_sdk/ambd_sdk/component/soc/realtek/amebad/app/monitor/include",
    "device-os/third_party/ambd_sdk/ambd_sdk/component/soc/realtek/amebad/misc",
    "device-os/third_party/ambd_sdk/ambd_sdk/component/os/os_dep/include",
    "device-os/third_party/ambd_sdk/ambd_sdk/component/os/freertos",
    "device-os/third_party/ambd_sdk/ambd_sdk/component/common/api",
    "device-os/third_party/ambd_sdk/ambd_sdk/component/common/api/platform",
    "device-os/third_party/ambd_sdk/ambd_sdk/component/common/api/wifi",
    # LwIP networking stack
    "device-os/third_party/lwip/lwip/src/include",
]

# =============================================================================
# Linker Scripts
# =============================================================================

# Export linker scripts for firmware linking
filegroup(
    name = "linker_scripts",
    srcs = glob([
        "device-os/modules/tron/user-part/*.ld",
        "device-os/modules/tron/system-part1/*.ld",
        "device-os/modules/shared/rtl872x/*.ld",
        "device-os/build/arm/linker/*.ld",
        "device-os/build/arm/linker/rtl872x/*.ld",
    ]) + [
        "//third_party/particle/rules:memory_platform_user.ld",
    ],
)

# =============================================================================
# Device OS Headers Library
# =============================================================================

cc_library(
    name = "device_os_headers",
    hdrs = glob(
        [
            "device-os/wiring/inc/**/*.h",
            "device-os/hal/inc/**/*.h",
            "device-os/hal/shared/**/*.h",
            "device-os/hal/src/tron/**/*.h",
            "device-os/hal/src/rtl872x/**/*.h",
            "device-os/hal/src/portable/**/*.h",
            "device-os/hal/network/**/*.h",
            "device-os/system/inc/**/*.h",
            "device-os/services/inc/**/*.h",
            "device-os/dynalib/inc/**/*.h",
            "device-os/dynalib/inc/**/*.inc",
            "device-os/platform/MCU/rtl872x/inc/**/*.h",
            "device-os/modules/shared/rtl872x/inc/**/*.h",
            "device-os/modules/shared/rtl872x/inc/**/*.c",  # textual includes
            "device-os/modules/shared/rtl872x/inc/**/*.inc",
            "device-os/communication/inc/**/*.h",
            "device-os/rt-dynalib/inc/**/*.h",
            # Realtek SDK headers
            "device-os/third_party/ambd_sdk/ambd_sdk/component/soc/realtek/amebad/**/*.h",
            "device-os/third_party/ambd_sdk/ambd_sdk/component/os/**/*.h",
            "device-os/third_party/ambd_sdk/ambd_sdk/component/common/api/**/*.h",
            # LwIP headers
            "device-os/third_party/lwip/lwip/src/include/**/*.h",
        ],
        allow_empty = True,
    ),
    includes = DEVICE_OS_INCLUDES,
    defines = DEVICE_OS_DEFINES,
    target_compatible_with = ["@pigweed//pw_build/constraints/arm:cortex-m33"],
)

# =============================================================================
# Wiring Libraries
# =============================================================================

# Wiring library - Arduino-compatible API (50 files)
cc_library(
    name = "wiring",
    srcs = glob(
        ["device-os/wiring/src/*.cpp"],
        exclude = [
            # Exclude files that use std::mutex/threading until we have proper gthread support
            "device-os/wiring/src/spark_wiring_thread.cpp",
            "device-os/wiring/src/spark_wiring_watchdog.cpp",
        ],
    ),
    copts = DEVICE_OS_CXXOPTS + [
        "-DLOG_MODULE_CATEGORY='\"wiring\"'",
        "-fno-builtin-malloc",
        "-fno-builtin-free",
        "-fno-builtin-realloc",
    ],
    deps = [":device_os_headers"],
    alwayslink = True,
    target_compatible_with = ["@pigweed//pw_build/constraints/arm:cortex-m33"],
)

# Wiring globals - global instances (8 files)
cc_library(
    name = "wiring_globals",
    srcs = glob(
        ["device-os/wiring_globals/src/*.cpp"],
        exclude = [
            # Exclude files that include spark_wiring_thread.h (uses std::mutex)
            "device-os/wiring_globals/src/spark_wiring_watchdog.cpp",
        ],
    ),
    copts = DEVICE_OS_CXXOPTS,
    deps = [":device_os_headers", ":wiring"],
    alwayslink = True,
    target_compatible_with = ["@pigweed//pw_build/constraints/arm:cortex-m33"],
)

# =============================================================================
# User-Part Module Glue
# =============================================================================

cc_library(
    name = "user_part_glue",
    srcs = [
        "device-os/modules/tron/user-part/src/module_info.c",
        "device-os/modules/tron/user-part/src/user_export.c",
        "device-os/modules/tron/user-part/src/user_module.c",
        "device-os/modules/tron/user-part/src/newlib_stubs.cpp",
    ],
    copts = DEVICE_OS_COPTS + [
        # Add -iquote for quoted includes to find .inc files
        "-iquote",
        "third_party/particle/device-os/modules/shared/rtl872x/inc/user-part",
        "-iquote",
        "third_party/particle/device-os/dynalib/inc",
    ],
    includes = DEVICE_OS_INCLUDES,
    defines = DEVICE_OS_DEFINES,
    deps = [":device_os_headers"],
    alwayslink = True,
    target_compatible_with = ["@pigweed//pw_build/constraints/arm:cortex-m33"],
)

# =============================================================================
# Dynalib Export Libraries
# =============================================================================

cc_library(
    name = "hal_dynalib",
    srcs = glob(["device-os/hal-dynalib/src/*.c"]),  # 27 files
    copts = DEVICE_OS_COPTS + ["-DDYNALIB_IMPORT"],  # hal-dynalib needs -D, others define it in source
    deps = [":device_os_headers"],
    alwayslink = True,
    target_compatible_with = ["@pigweed//pw_build/constraints/arm:cortex-m33"],
)

cc_library(
    name = "services_dynalib",
    srcs = ["device-os/services-dynalib/src/services_dynalib.c"],
    copts = DEVICE_OS_COPTS,
    deps = [":device_os_headers"],
    alwayslink = True,
    target_compatible_with = ["@pigweed//pw_build/constraints/arm:cortex-m33"],
)

cc_library(
    name = "system_dynalib",
    srcs = glob(["device-os/system-dynalib/src/*.c"]),
    copts = DEVICE_OS_COPTS,
    deps = [":device_os_headers"],
    alwayslink = True,
    target_compatible_with = ["@pigweed//pw_build/constraints/arm:cortex-m33"],
)

cc_library(
    name = "rt_dynalib",
    srcs = ["device-os/rt-dynalib/src/rt_dynalib.c"],
    copts = DEVICE_OS_COPTS,
    deps = [":device_os_headers"],
    alwayslink = True,
    target_compatible_with = ["@pigweed//pw_build/constraints/arm:cortex-m33"],
)

cc_library(
    name = "communication_dynalib",
    srcs = ["device-os/communication-dynalib/src/communication_dynalib.c"],
    copts = DEVICE_OS_COPTS,
    deps = [":device_os_headers"],
    alwayslink = True,
    target_compatible_with = ["@pigweed//pw_build/constraints/arm:cortex-m33"],
)

# =============================================================================
# Combined Device OS User-Part Library
# =============================================================================

cc_library(
    name = "device_os_user_part",
    deps = [
        ":user_part_glue",
        ":hal_dynalib",
        ":services_dynalib",
        ":system_dynalib",
        ":rt_dynalib",
        ":communication_dynalib",
        # Note: wiring/wiring_globals excluded - using Pigweed abstractions instead
    ],
    target_compatible_with = ["@pigweed//pw_build/constraints/arm:cortex-m33"],
)

# =============================================================================
# Pigweed Integration
# =============================================================================

# Minimal pw_assert stub that doesn't require pw_sys_io
cc_library(
    name = "pw_assert_stub",
    srcs = ["pw_assert_stub.cc"],
    copts = DEVICE_OS_CXXOPTS,
    alwayslink = True,  # Ensure this is always linked
    target_compatible_with = ["@pigweed//pw_build/constraints/arm:cortex-m33"],
)
